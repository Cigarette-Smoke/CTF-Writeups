Link: https://play.picoctf.org/practice/challenge/433?category=6&originalEvent=73&page=1

# format string 0

Author: Cheng Zhang

Difficulty: Easy

Description:

```
Can you use your knowledge of format strings to make the customers happy?
Download the binary here.
Download the source here.
Connect with the challenge instance here:
nc mimas.picoctf.net XXXXX
```

### Tools used
- Visual Studio 2022

## Analyzing the server program
<img width="699" height="119" alt="image" src="https://github.com/user-attachments/assets/0bf6d7de-5559-45be-b299-091f772eac1b" />

- Upon opening the program for the first time, one might assume that in order to get the flag, one has to fill the endless bellies of Patrick and Spongebob with food. You are mistaken. Patrick and Spongebob are filthy liars, using you as a means to get free food.

## Source Code Analysis
- Jokes aside, if we analyze the source code, we will see that fulfilling their requests will simply end the program without printing the flag.
- Our flag is printed whenever a [SIGSEGV](https://en.cppreference.com/w/c/program/SIG_types) signal is triggered. This begs for a logical question - how can we cause a [segmentation fault](https://en.wikipedia.org/wiki/Segmentation_fault) during runtime?
- The program scans our first input on the stack with **no length limit,** making it vulnerable to [stack overflow](https://www.geeksforgeeks.org/cpp/heap-overflow-stack-overflow/).
```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 32
#define FLAGSIZE 64

char flag[FLAGSIZE];

void sigsegv_handler(int sig) { // THIS SIGNAL PRINTS THE FLAG
    printf("\n%s\n", flag); 
    fflush(stdout);
    exit(1);
}

int on_menu(char *burger, char *menu[], int count) {
    for (int i = 0; i < count; i++) {
        if (strcmp(burger, menu[i]) == 0)
            return 1;
    }
    return 0;
}

void serve_patrick();

void serve_bob();


int main(int argc, char **argv){
    FILE *f = fopen("flag.txt", "r");
    if (f == NULL) {
        printf("%s %s", "Please create 'flag.txt' in this directory with your",
                        "own debugging flag.\n");
        exit(0);
    }

    fgets(flag, FLAGSIZE, f);
    signal(SIGSEGV, sigsegv_handler);

    gid_t gid = getegid();
    setresgid(gid, gid, gid);

    serve_patrick();
  
    return 0;
}

void serve_patrick() {
    printf("%s %s\n%s\n%s %s\n%s",
            "Welcome to our newly-opened burger place Pico 'n Patty!",
            "Can you help the picky customers find their favorite burger?",
            "Here comes the first customer Patrick who wants a giant bite.",
            "Please choose from the following burgers:",
            "Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice1[BUFSIZE];
    scanf("%s", choice1);
    char *menu1[3] = {"Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe"};
    if (!on_menu(choice1, menu1, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        int count = printf(choice1);
        if (count > 2 * BUFSIZE) {
            serve_bob();
        } else {
            printf("%s\n%s\n",
                    "Patrick is still hungry!",
                    "Try to serve him something of larger size!");
            fflush(stdout);
        }
    }
}

void serve_bob() {
    printf("\n%s %s\n%s %s\n%s %s\n%s",
            "Good job! Patrick is happy!",
            "Now can you serve the second customer?",
            "Sponge Bob wants something outrageous that would break the shop",
            "(better be served quick before the shop owner kicks you out!)",
            "Please choose from the following burgers:",
            "Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice2[BUFSIZE];
    scanf("%s", choice2);
    char *menu2[3] = {"Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak"};
    if (!on_menu(choice2, menu2, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        printf(choice2);
        fflush(stdout);
    }
}
```

# Segmentation Fault

- I tweaked the code a little bit and built the program locally using Visual Studio 2022 to debug it.
```C
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <sys/types.h>

#define BUFSIZE 32
#define FLAGSIZE 64

void sigsegv_handler(int sig) {
    printf("\n picoCTF{flag} \n");
    fflush(stdout);
    exit(1);
}


#pragma warning(disable : 4996) // disables compiler warning messages regarding unsafe scanf's
int on_menu(char* burger, char* menu[], int count) {
    for (int i = 0; i < count; i++) {
        if (strcmp(burger, menu[i]) == 0)
            return 1;
    }
    return 0;
}

void serve_patrick();

void serve_bob();


int main(int argc, char** argv) {
    signal(SIGSEGV, sigsegv_handler);

    serve_patrick();

    return 0;
}

void serve_patrick() {
    printf("%s %s\n%s\n%s %s\n%s",
        "Welcome to our newly-opened burger place Pico 'n Patty!",
        "Can you help the picky customers find their favorite burger?",
        "Here comes the first customer Patrick who wants a giant bite.",
        "Please choose from the following burgers:",
        "Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe",
        "Enter your recommendation: ");
    fflush(stdout);

    char choice1[BUFSIZE];
    scanf("%s", choice1);
    char* menu1[3] = { "Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe" };
    if (!on_menu(choice1, menu1, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    }
    else {
        int count = printf(choice1);
        if (count > 2 * BUFSIZE) {
            serve_bob();
        }
        else {
            printf("\n%s\n%s\n",
                "Patrick is still hungry!",
                "Try to serve him something of larger size!");
            fflush(stdout);
        }
    }
}

void serve_bob() {
    printf("\n%s %s\n%s %s\n%s %s\n%s",
        "Good job! Patrick is happy!",
        "Now can you serve the second customer?",
        "Sponge Bob wants something outrageous that would break the shop",
        "(better be served quick before the shop owner kicks you out!)",
        "Please choose from the following burgers:",
        "Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak",
        "Enter your recommendation: ");
    fflush(stdout);

    char choice2[BUFSIZE];
    scanf("%s", choice2);
    char* menu2[3] = { "Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak" };
    if (!on_menu(choice2, menu2, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    }
    else {
        printf(choice2);
        fflush(stdout);
    }
}
```

- I then ran the program and triggered a segmentation fault by inputting a string so large that the stack just simply couldn't store it. (Access violation = Segmentation Fault)
<img width="1687" height="757" alt="image" src="https://github.com/user-attachments/assets/1ab3fc40-9b2e-4fd3-a3ac-3f3f54cf6803" />

### Note: 
- [scanf()](https://en.cppreference.com/w/c/io/fscanf) has automatic formatting that treats whitespaces (i.e., end of line, spaces, end of file, etc.) as the end of the input, meaning everything that comes after the whitespace will not be written to the string. Notice how in the following case, the program doesn't throw an unhandled stack buffer overflow exception, and if we look at the value of our input variable in the Autos/Locals section, we will see that nothing past Breakf@st_Burger was written to the string.
<img width="1691" height="536" alt="image" src="https://github.com/user-attachments/assets/263e2aff-d124-4a64-abfe-db7a1c900ccd" />

# Exploiting an unsafe scanf()
<img width="1892" height="510" alt="image" src="https://github.com/user-attachments/assets/560a6c93-c9ca-4f51-bb00-51f387134011" />
<img width="1896" height="483" alt="image" src="https://github.com/user-attachments/assets/019b5a68-f07c-4c65-887d-644d2689aaa8" />
