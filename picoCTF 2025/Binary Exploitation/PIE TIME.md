Link: https://play.picoctf.org/practice/challenge/490?category=6&page=1

# PIE TIME

Author: Darkraicg492

Difficulty: Easy

Description:

```
Can you try to get the flag? Beware we have PIE!
Connect to the program with netcat:
$ nc rescued-float.picoctf.net 58982
The program's source code can be downloaded here. The binary can be downloaded here.
```

## Source Code Analysis
```C
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void segfault_handler() {
  printf("Segfault Occurred, incorrect address.\n");
  exit(0);
}

int win() {
  FILE *fptr;
  char c;

  printf("You won!\n");
  // Open file
  fptr = fopen("flag.txt", "r");
  if (fptr == NULL)
  {
      printf("Cannot open file.\n");
      exit(0);
  }

  // Read contents from file
  c = fgetc(fptr);
  while (c != EOF)
  {
      printf ("%c", c);
      c = fgetc(fptr);
  }

  printf("\n");
  fclose(fptr);
}

int main() {
  signal(SIGSEGV, segfault_handler);
  setvbuf(stdout, NULL, _IONBF, 0); // _IONBF = Unbuffered

  printf("Address of main: %p\n", &main);

  unsigned long val;
  printf("Enter the address to jump to, ex => 0x12345: ");
  scanf("%lx", &val);
  printf("Your input: %lx\n", val);

  void (*foo)(void) = (void (*)())val;
  foo();
}
```

```
unsigned long val;
printf(" enter the address to jump to, ex => 0x12345: ");
scanf("%lx", &val);

void (*foo)(void) = (void (*)())val;
foo();
```
- The last 2 lines of code inside of int main() immediately caught my attention because ```void (*foo)(void) = (void (*)())val;``` creates a function pointer that returns nothing and doesn't take in any arguments, while assigning itself the value of val. This means that we can assign any function to foo (and then subsequently call it) by giving val the said function's address.

## Binary Analysis
- To acquire win()'s address I disassembled the binary using [Cutter](https://github.com/rizinorg/cutter).

<img width="269" height="66" alt="image" src="https://github.com/user-attachments/assets/c6fa1962-299e-4800-b954-749c6e0d9fbd" />

- However, we can't just paste the raw address of win() as our input because if we connect to the program with netcat we will see that the address of main is not the same.
<img width="581" height="174" alt="image" src="https://github.com/user-attachments/assets/218d2afc-b4e5-4ae4-83da-78fa3592536b" />

- But do you know what will always remain the same in this program? How far away functions are positioned from each other.
- I calculated the position difference between main() and win() within the binary file: 0x133d - 0x12a7 = 0x96
<img width="348" height="91" alt="image" src="https://github.com/user-attachments/assets/287ed984-4175-4e54-bcc9-8dfc70ed3103" />

## Solution

- Now, if I connect to the netcat program and subtract 0x96 from any given address of main() I will always get the adjusted address of win().
<img width="585" height="163" alt="image" src="https://github.com/user-attachments/assets/e2d02601-3aef-4a1e-9fee-94406bf4ba71" />


- In this case, the given main() address is 0x5d836b78133d, and if we subtract 0x5d836b78133d - 0x96 = 0x5d836b7812a7, we will get the address of win().
